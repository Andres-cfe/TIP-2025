/**
 *
 * Módulo course360 para gestionar funciones y solicitudes relacionadas con la navegación de un curso eLearning.
 * Proporciona métodos para cargar contenido, manejar audio, integrar con SCORM y más.
 *
 * @namespace course360
 * @version 1.0.0
 *
 * @requires jQuery
 * @requires pipwerks SCORM Wrapper for JavaScript
 * @requires Howler.js
 * @requires SweetAlert2.js
 * @requires Bootstrap@4.6.2
 * @requires Swiper 11.1.5
 *
 * @class ExtendedHowl
 * @extends Howl
 * @classdesc Extiende la clase Howl para añadir funcionalidad de actualización de tiempo.
 * @method onTimeUpdate - Añade un listener para actualizaciones de tiempo.
 * @method offTimeUpdate - Elimina un listener de actualizaciones de tiempo.
 * @method _startTimeUpdate - Inicia el intervalo para actualizaciones de tiempo.
 * @method _emitTimeUpdate - Emite las actualizaciones de tiempo a los listeners.
 *
 * @class AudioController
 * @classdesc Controlador para la gestión del audio en el curso.
 * @method loadAudio - Carga un archivo de audio dado su URL.
 * @method playAudio - Reproduce el audio cargado.
 * @method pauseAudio - Pausa el audio reproducido.
 * @method stopAudio - Detiene el audio reproducido.
 * @method toggleAudio - Alterna entre reproducir y pausar el audio.
 * @method toggleMute - Silencia o activa el sonido del audio.
 * @method updateUI - Actualiza la interfaz de usuario del control de audio.
 * @method setAudioUrl - Establece un nuevo archivo de audio para reproducir.
 * @method setAudio - Establece una nueva instancia de Howl para reproducir.
 *
 * @function initializeScorm - Inicializa la conexión con SCORM.
 * @function setProgress - Guarda el progreso del usuario en SCORM o sessionStorage.
 * @function getProgress - Obtiene el progreso del usuario desde SCORM o sessionStorage.
 * @function finishScorm - Finaliza y guarda el progreso del curso en SCORM.
 * @function loadConfig - Carga la configuración del curso desde un archivo JSON.
 * @function initializeCourse - Inicializa el curso, configurando el título y el menú.
 * @function buildMenu - Construye el menú de navegación del curso.
 * @function loadContent - Carga el contenido del módulo o tema actual.
 * @function setupNavigation - Configura los botones de navegación (anterior y siguiente).
 * @function updateProgressBar - Actualiza la barra de progreso del curso.
 * @function setActiveMenuItem - Establece el ítem activo del menú basado en el módulo o tema actual.
 * @function openSidebar - Abre el menú lateral de navegación.
 * @function closeSidebar - Cierra el menú lateral de navegación.
 * @function showStartOptions - Muestra las opciones de inicio al usuario.
 * @function verifyContentArray - Verifica y actualiza el array de contenido guardado.
 *
 * @license Licencia Comercial Propietaria
 * @version 1.0.0
 * @author salvador.martinez@espacio360.com.mx
 * @copyright Este software está protegido por derechos de autor y es propiedad de E360 Digital Solutions S.A. de C.V.
 * Solo se permite su uso de acuerdo con los términos y condiciones establecidos en el contrato de licencia.
 * Para obtener una licencia y acceder a las características completas y el soporte, contáctenos en licencias@espacio360.com.mx
 *
 */
var course360=function(e){"use strict";class t extends Howl{constructor(e){super(e),this._timeupdateListeners=[],this._interval=null,this._startTimeUpdate()}_startTimeUpdate(){this._interval=setInterval((()=>{if(this.playing()){const e=this.seek();this._emitTimeUpdate(e)}}),250)}_emitTimeUpdate(e){this._timeupdateListeners.forEach((t=>t(e)))}onTimeUpdate(e){this._timeupdateListeners.push(e)}offTimeUpdate(e){this._timeupdateListeners=this._timeupdateListeners.filter((t=>t!==e))}stop(e){super.stop(e),clearInterval(this._interval),this._interval=null}pause(e){super.pause(e),clearInterval(this._interval),this._interval=null}play(e){const t=super.play(e);return this._startTimeUpdate(),t}}class n{constructor(){this.audioElement=null,this.audioControlButton=document.getElementById("audio-control"),this.audioIcon=document.getElementById("audio-icon"),this.audioControlButton.addEventListener("click",this.toggleMute.bind(this)),this.progressCircle=document.getElementById("progress-circle"),this.audioProgress=document.getElementById("audio-progress"),this.isPlaying=!1,this.isMuted=!1,this.audioProgress.style.display="none"}loadAudio(e){this.stopAudio(),e?(this.audioElement=new t({src:[e],onend:this.onEnd.bind(this),onplay:this.onPlay.bind(this),onpause:this.onPause.bind(this),onstop:this.onStop.bind(this),onmute:this.onMute.bind(this)}),this.audioElement.onTimeUpdate(this.updateProgressCircle.bind(this))):(this.stopAudio(),this.audioElement=null)}playAudio(){this.audioElement&&this.audioElement.play()}pauseAudio(){this.audioElement&&this.audioElement.pause()}stopAudio(){this.audioElement&&this.audioElement.stop&&this.audioElement.stop(),this.isPlaying=!1}toggleAudio(){this.audioElement&&(this.audioElement.playing()?this.pauseAudio():this.playAudio())}toggleMute(){this.isMuted=!this.isMuted,Howler.mute(this.isMuted),this.updateIcon(),this.isMuted?$("video").prop("muted",!0):$("video").prop("muted",!1)}updateIcon(){this.isMuted?this.audioIcon.className="fa-duotone fa-solid fa-volume-slash":this.audioIcon.className="fa-duotone fa-solid fa-volume"}updateUI(){this.audioElement&&this.audioElement.playing()?this.audioIcon.className="fa-duotone fa-solid fa-pause":this.audioIcon.className="fa-duotone fa-solid fa-play"}setAudioUrl(e){this.loadAudio(e)}setAudio(e){e instanceof t&&(this.audioElement&&this.audioElement.stop(),this.audioElement=e,this.audioElement.on("end",this.onEnd.bind(this)),this.audioElement.on("play",this.onPlay.bind(this)),this.audioElement.on("pause",this.onPause.bind(this)),this.audioElement.on("stop",this.onStop.bind(this)),this.audioElement.on("mute",this.onMute.bind(this)),this.audioElement.onTimeUpdate(this.updateProgressCircle.bind(this)))}onPlay(){this.isPlaying=!0,this.audioProgress.style.display="block",this.updateProgressCircle()}onPause(){this.updateUI(),this.isPlaying=!1}onStop(){this.isPlaying=!1,this.audioProgress.style.display="none",this.updateProgressCircle()}onEnd(){this.audioProgress.style.display="none",this.updateProgressCircle(),this.isPlaying=!1}onMute(){this.toggleMute()}stopAllSoundsAndPlay(e){Array.isArray(Howler._howls)&&Howler._howls.forEach((e=>{e.stop()})),this.setAudio(e),this.playAudio()}updateProgressCircle(e){if(!this.audioElement)return;const t=this.progressCircle.getAttribute("r"),n=2*Math.PI*t,i=e/this.audioElement.duration()*n;this.progressCircle.setAttribute("stroke-dashoffset",n-i)}}const i=e.COURSE_CONFIG_URL||"config.json",s=void 0!==e.DEBUG&&e.DEBUG,o=new n;let a,r,c=!1,d={contentArray:[],maximumAdvance:0},l=null,u=0,m=!1,p=[];const h=new Audio("audio/click.mp3");function f(e){const t=JSON.stringify(e);if(pipwerks.SCORM.connection.isActive){let e=pipwerks.SCORM;e.set("cmi.suspend_data",t),e.save()}else sessionStorage.setItem("courseProgress",t)}function g(){fetch(i).then((e=>e.json())).then((e=>{l=e,function(e){let t=-1;e.forEach(((e,n)=>{t=n,S(e.title,e.content,e.audio,t),e.topics&&v(e.topics,t)}))}(l.modules),d=function(){let e,t;const n=pipwerks.SCORM;if(n.connection.isActive){e=n.get("cmi.suspend_data")||!1}else e=!!sessionStorage.getItem("courseProgress")&&sessionStorage.getItem("courseProgress");try{return t=!1===e?{contentArray:[],maximumAdvance:0}:JSON.parse(e),t}catch(e){return{contentArray:[],maximumAdvance:0}}}(),!function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)e[n].title===t[n].title&&e[n].content===t[n].content||(e[n].title=t[n].title,e[n].content=t[n].content,e[n].audio=t[n].audio);return!0}(d.contentArray,p)?(d={contentArray:p,maximumAdvance:0},f(d)):p=d.contentArray,d.contentArray.forEach((e=>{$("#content-area").append('<div class="swiper-slide sco"><div class="d-flex justify-content-center align-items-center h-100"><i class="fa-duotone fa-solid fa-spinner-third fa-spin fa-2xl"></i></div></div>')})),r=new Swiper(".swiper",{direction:"vertical",allowTouchMove:!1,pagination:{el:".swiper-pagination",clickable:!1,enabled:!1},on:{slideChange:x,slideNextTransitionStart:function(){},slidePrevTransitionStart:function(){},resize:x}}),d.maximumAdvance>0?Swal.fire({title:"¿Dónde quieres empezar?",text:"Puedes retomar tu progreso o comenzar desde el principio.",icon:"question",showCancelButton:!0,confirmButtonText:"Retomar",cancelButtonText:"Comenzar de nuevo"}).then((e=>{u=e.isConfirmed?d.maximumAdvance:0,y()})):y()})).catch((e=>{}))}function y(){const e=document.getElementsByClassName("course-title");for(let t=0;t<e.length;t++)e[t].innerText=l.title;document.title=l.title,E(),A(),document.getElementById("prev-btn").addEventListener("click",(function(){h.play(),M(-1)})),document.getElementById("next-btn").addEventListener("click",(function(){h.play(),M(1)})),C()}function v(e,t){e.forEach((e=>{S(e.title,e.content,e.audio,t),e.topics&&v(e.topics,t)}))}function S(e,t,n,i){t&&p.push({title:e,content:t,audio:n,visited:!1,indexModule:i,index:p.length})}function w(e,t){let n=document.createElement("li");n.classList.add("menu-item");const i=d.contentArray.find((t=>t.content===e.content&&t.title===e.title))||{index:-1};let o=document.createElement("div");o.classList.add("witem");let a=document.createElement("a");if(a.dataset.index=i.index,a.textContent=e.title,a.dataset.visited=i.visited,a.classList.add("nav-link","nav-e360-menu"),a.addEventListener("click",(function(){if(h.play(),i.index>-1)s||"true"===a.dataset.visited?(u=i.index,I(),C()):(I(),Swal.fire({text:"El tema está bloqueado",icon:"error"}));else{const e=a.closest(".witem").querySelector(".toggle-icon");e&&e.click()}})),o.appendChild(a),n.appendChild(o),e.topics&&e.topics.length>0){let t=document.createElement("span");t.classList.add("toggle-icon","btn","btn-sm"),t.innerHTML='<i class="fa-duotone fa-solid fa-square-chevron-right"></i>',t.addEventListener("click",(function(){h.play();const e=this.querySelector("i"),t=this.closest("li").querySelector("ul");$(t).collapse("toggle"),$(t).on("shown.bs.collapse",(function(){e.classList.remove("fa-square-chevron-right"),e.classList.add("fa-square-chevron-down")})),$(t).on("hidden.bs.collapse",(function(){e.classList.remove("fa-square-chevron-down"),e.classList.add("fa-square-chevron-right")}))})),o.appendChild(t);let i=document.createElement("ul");i.classList.add("collapse","list-unstyled","sub-ul"),e.topics.forEach(((e,t)=>{i.appendChild(w(e,t))})),n.appendChild(i)}return n}function E(){let e=document.getElementById("menu");e.innerHTML="",l.modules&&l.modules.length>0&&l.modules.forEach(((t,n)=>{let i=document.createElement("ul");i.id=`module${n}`,i.classList.add("list-unstyled"),i.appendChild(w(t)),e.appendChild(i)}))}function A(){document.querySelectorAll("#menu > ul").forEach((e=>{const t=e.querySelectorAll(".nav-e360-menu"),n={};t.forEach((e=>{const t=function(e){let t=0;for(;e.parentElement;)(e=e.parentElement).classList.contains("list-unstyled")&&t++;return t}(e);n[t]||(n[t]=new Set),n[t].has(e.textContent.trim())?(e.style.display="none",e.closest(".menu-item").style.display="none"):n[t].add(e.textContent.trim())}))}))}function C(){document.getElementById("loader-course360").style.display="block";const e=d.contentArray[u];if(!e)return;const t=e.content,n=e.audio;if(!t)return;(Array.isArray(Howler._howls)&&$.each(Howler._howls,(function(e,t){t.stop(),t.off()})),"undefined"!=typeof gsap&&null!==gsap&&gsap.globalTimeline.clear(),o&&o.audioElement&&o.stop(),Swal.isVisible())&&(Swal.close(),document.querySelectorAll(".swal2-shown, .swal2-height-auto").forEach((function(e){e.classList.remove("swal2-shown","swal2-height-auto")})),document.querySelectorAll('[aria-hidden="true"]').forEach((function(e){e.removeAttribute("aria-hidden")})));document.getElementById("next-btn").classList.remove("look_at_me"),$.ajax({url:t,dataType:"html",success:function(e){$(".sco").each((function(){$(this).html('<div class="d-flex justify-content-center align-items-center h-100"><i class="fa-duotone fa-solid fa-spinner-third fa-spin fa-2xl"></i></div>')})),$("#content-area").find(".swiper-slide").eq(u).html(e),x()},error:function(e){$("#content-area").find(".swiper-slide").eq(u).html(e.responseText)},complete:function(){n&&o.setAudioUrl(n),s&&(d.contentArray[u].visited=!0),d.maximumAdvance=Math.max(d.maximumAdvance,u),f(d),b(),function(){const e=document.querySelectorAll("#menu .nav-link");e.forEach((e=>e.classList.remove("active")));const t=document.querySelector(`[data-index="${u}"]`);t&&(t.classList.add("active"),"none"===t.style.display&&e.forEach((e=>{e.textContent.trim()===t.textContent.trim()&&e.classList.add("active")})))}(),k(),document.getElementById("loader-course360").style.display="none",r.update(),r.slideTo(u),function(e,t,n){const i=new CustomEvent("slideChange",{detail:{message:"Slide changed!",slideIndex:e,totalSlides:t,slide:n}});document.body.dispatchEvent(i)}(u,d.contentArray.length,d.contentArray[u])}})}function M(e){const t=u+e;t<0||t>=d.contentArray.length||(-1===e||d.contentArray[u].visited||s?(u=t,C()):Swal.fire({text:"Debes completar el contenido actual antes de avanzar.",icon:"warning"}),k())}function b(){const e=document.getElementById("progress-bar"),t=d.contentArray.filter((e=>e.visited)).length/d.contentArray.length*100;e.style.width=`${t}%`,e.innerHTML=`${t.toFixed(2)}%`,e.setAttribute("aria-valuenow",t.toFixed(2))}function k(){const e=document.getElementById("prev-btn"),t=document.getElementById("next-btn");0===u?e.classList.add("disabled"):e.classList.remove("disabled"),u>=d.contentArray.length-1||!d.contentArray[u].visited&&!s?t.classList.add("disabled"):t.classList.remove("disabled")}function L(){h.play(),document.getElementById("sidebar").classList.add("active"),document.querySelector("main").classList.add("sidebar-open"),document.querySelector("nav").classList.add("sidebar-open"),document.querySelector("footer").classList.add("sidebar-open"),m=!0}function I(){h.play(),document.getElementById("sidebar").classList.remove("active"),document.querySelector("main").classList.remove("sidebar-open"),document.querySelector("nav").classList.remove("sidebar-open"),document.querySelector("footer").classList.remove("sidebar-open"),m=!1}function x(){const e=document.getElementById("main-content"),t=document.getElementById("nav-course360"),n=document.getElementById("footer-360");let i=t?t.offsetHeight:0,s=n?n.offsetHeight:0;e.style.height=`calc(100vh - ${i+s}px)`}function _(e=!0){try{if(!d.contentArray[u].visited&&u<d.contentArray.length-1){document.getElementById("next-btn").classList.add("look_at_me")}d.contentArray[u].visited=e,document.querySelector(`[data-index="${u}"]`).dataset.visited=e,b(),k(),O(),function(e,t,n){const i=new CustomEvent("slideCompleted",{detail:{message:"Slide Completed!",slideIndex:e,totalSlides:t,slide:n}});document.body.dispatchEvent(i)}(u,d.contentArray.length,d.contentArray[u])}catch(e){}}function O(){if(!pipwerks.SCORM.connection.isActive)return f(d),!0;pipwerks.SCORM.save()}return pipwerks.SCORM.version="1.2",pipwerks.debug.isActive=s,pipwerks.SCORM.handleExitMode=!1,document.getElementById("menu-toggle").addEventListener("click",(function(){m?I():L()})),document.getElementById("btn-close-menu-sm").addEventListener("click",(function(){I()})),document.addEventListener("DOMContentLoaded",(function(){!function(e){let t=pipwerks.SCORM,n=t.init();n&&("not attempted"===t.get("cmi.core.lesson_status")&&(t.set("cmi.core.lesson_status","incomplete"),t.save()),a=new Date);e(n)}((e=>{if(s)g();else if(e)g();else{const e=pipwerks.SCORM.debug.getInfo(pipwerks.SCORM.debug.getCode());Swal.fire({icon:"error",text:"No se encontró la API SCORM, si estas en un LMS puede ser que no se guarde los datos del curso. "+e,didClose:()=>{g()}})}}))})),window.addEventListener("load",x),window.addEventListener("resize",x),window.addEventListener("beforeunload",(function(){if(pipwerks.SCORM.connection.isActive&&!c){const e=function(e){const t=Math.floor(e/3600).toString().padStart(2,"0"),n=Math.floor(e%3600/60).toString().padStart(2,"0"),i=(e%60).toFixed(2).toString().padStart(5,"0");return`${t}:${n}:${i}`}((new Date-a)/1e3);pipwerks.SCORM.set("cmi.core.session_time",e),pipwerks.SCORM.save(),pipwerks.SCORM.quit(),c=!0}})),{audioController:new n,getStudentName:function(){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get("cmi.core.student_name"):sessionStorage.getItem("cmi.core.student_name")},getLessonLocation:function(){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get("cmi.core.lesson_location"):sessionStorage.getItem("cmi.core.lesson_location")},setLessonLocation:function(e){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.set("cmi.core.lesson_location",e):(sessionStorage.setItem("cmi.core.lesson_location",e),!0)},getLessonStatus:function(){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get("cmi.core.lesson_status"):sessionStorage.getItem("cmi.core.lesson_status")},setLessonStatus:function(e){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.set("cmi.core.lesson_status",e):(sessionStorage.setItem("cmi.core.lesson_status",e),!0)},getScore:function(){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get("cmi.core.score.raw"):sessionStorage.getItem("cmi.core.score.raw")},setScore:function(e){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.set("cmi.core.score.raw",e):(sessionStorage.setItem("cmi.core.score.raw",e),!0)},getSuspendData:function(){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get("cmi.suspend_data"):sessionStorage.getItem("cmi.suspend_data")},setSuspendData:function(e){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.set("cmi.suspend_data",e):(sessionStorage.setItem("cmi.suspend_data",e),!0)},createSound:function(e){return new t({src:[e]})},setSlideVisited:_,soundClick:function(){h.play()},isVisited:function(){return d.contentArray[u].visited},isDebug:s,nextSlide:function(){u++,C()},save:O,openSidebar:L,closeSidebar:I,reload:function(){C()},gotoSlide:function(e){if(!isNaN(e)&&"number"==typeof e){const t=Math.floor(e);t>=0&&t<d.contentArray.length&&(u=t,C())}},isCompletedSlideIndex:function(e){if(!isNaN(e)&&"number"==typeof e){const t=Math.floor(e);return t>=0&&t<d.contentArray.length?d.contentArray[t].visited:void 0}},getCurrentSlide:function(){return"number"==typeof u&&!isNaN(u)&&u>=0&&u<d.contentArray.length?d.contentArray[u]:void 0},prevSlide:function(){u--,C()},resetCourse:function(){d.contentArray.forEach((e=>e.visited=!1)),d.maximumAdvance=0,u=0,pipwerks.SCORM.connection.isActive?(pipwerks.SCORM.set("cmi.core.lesson_location",0),pipwerks.SCORM.set("cmi.core.score.raw",0),pipwerks.SCORM.save()):(sessionStorage.removeItem("cmi.core.lesson_location"),sessionStorage.removeItem("cmi.core.score.raw"),sessionStorage.removeItem("cmi.core.lesson_status")),f(d),E(),A(),C()},adjustMainContentHeight:x,markSlidesAsVisited:function(e){e.sort(((e,t)=>t-e)).forEach((e=>{try{u=e,_(!0)}catch(e){}}))},scormGetValue:function(e){return pipwerks.SCORM.connection.isActive?pipwerks.SCORM.get(e):null},scormSetValue:function(e,t){return!!pipwerks.SCORM.connection.isActive&&pipwerks.SCORM.set(e,t)}}}(COURSE_CONFIG);